<!doctype html>
<html>
<head>
<title>Kanban board</title>
<style>
  * {
    border: 0;
    margin: 0;
    font-family: 'Courier New', monospace;
    box-sizing: border-box;
  }

  .kanban-table {
    width: 100%;
    border-collapse: collapse;
    border: 0px solid black;
    table-layout: fixed;
  }

  .kanban-table td, .kanban-table th {
    border: 0px solid black; 
  }

  .column.in-progress {
    background-color: lightyellow;
  }

  .column.todo {
    background-color: lightblue;
  }

  .column.done {
    background-color: lightgreen;
  }
  .column-header {
    padding: 10px;
    text-align: center;
    font-size: 26px;
  }

  .card  {
    margin: 20px;
    padding: 20px;
    background-color: white;
    font-size: 18px;
  }

  .new-card  {
    margin: 20px;
    background-color: white;
  }
  .new-card-input {
    padding: 20px;
    font-size: 18px;
    width: 100%;
  }
</style>
<script src="underscore.js"></script>
<script src="zepto.js"></script>

<script>
var getColumnStyle = function (columns, i, column, width) {
  // note we are not using the supplied width
  var styleWidth = (innerWidth / columns.length)
  var styleLeft = i * styleWidth;
  var style="width: " + styleWidth + "px;"
    + " position: absolute; "
    + " left: " + styleLeft + "px; "
  return style;
}

var findClosestCardAbove = function (x, y, el) {
  for (i = y; i >= 0; i-=5) {
    var newEl = document.elementFromPoint(x, i)
    if (newEl != el && $(newEl).hasClass("card")) {
      return {card: newEl, distance: i} 
    }
  } 
  return {card: null, distance: Infinity}
}

var findClosestCardBelow = function (x, y, el) {
  var pageHeight = $(document).height() || 5000
  for (i = y; i <= pageHeight; i+=5) {
    var newEl = document.elementFromPoint(x, i)
    if (newEl != el && $(newEl).hasClass("card")) {
      return {card: newEl, distance: i} 
    }
  } 
  return {card: null, distance: Infinity}
}

var handleDropColumn = function (event, el) {
  console.log(event);

  // find element because you can't rely on event.target
  // because we could be dropping in the margin
  var el = document.elementFromPoint(event.pageX, event.pageY)
  console.log(el.dataset.columnId)
  var columnId = el.dataset.columnId
  console.log(event.target.innerHTML)
  // if event.dataTransfer.type == "card"
  var cardAbove = findClosestCardAbove(event.pageX, event.pageY, el)
  var cardBelow = findClosestCardBelow(event.pageX, event.pageY, el)

  if (!cardAbove.card) {
    var pos = "first"
  } else if(!cardBelow.card) {
    var pos = "last"
  } else if (!$(el).hasClass("card")){
    if (cardAbove.distance < cardBelow.distance) {
      var pos = cardAbove.card.dataset.order
    } else {
      var pos = el.dataset.order
    }
  } else {
    var pos = cardAbove.card.dataset.order
  }
  console.log(pos)
  
  handle({cardMove: {id: event.dataTransfer.id, columnId: columnId}})
}

var handle = function (event) {
  // for now the flow is: events go to server then we render based on
  // what we get back from the server
  
  socket.emit("appEvent", event) // the server has the state
  //render(kanbanApp(state, event))
}

var handleDragStartCard = function (event) {
  event.dataTransfer.type = "card"
  console.log(event.target)
  event.dataTransfer.id = event.target.id
  console.log(event.dataTransfer)
}

var handleSumbitCard = function (event, columnId, el) {
  var text = $(el).find(".new-card-input").val()
  handle({newCard: {columnId: columnId, text: text}})
  event.preventDefault()
}


</script>

<script type="text/html" id="kanbanTemplate">

  <% _.each(columns, function (column, i) { %>
    <div data-column-id="<%= column.id %>" class="column <%= column.id%>" ondragover="event.preventDefault()" ondrop="handleDropColumn(event, this)" style="<%= getColumnStyle(columns, i, column) %>">
      <div class="column-header"><%= column.title %></div>
      <% _.each(column.cards, function (card, i) { %>
        <div class="card card-like" data-order="<%= i %>" draggable="true" id="<%= card.id %>" ondragstart="handleDragStartCard(event)">
          <%= card.title %> 
        </div> 
      <% }) %>
        <div class="new-card card-like">
          <form onsubmit="handleSumbitCard(event, '<%= column.id %>', this)">
          <input type="text" class="new-card-input"> 
        </form>
        </div> 
    </div> 
  <% }) %>
  

</script>

<script src="socket.io.js"></script>
<script src="kanban.js"></script>
</head>
<body>
  <div id="kanban"></div>

</body>
<script>
var socket = io.connect('http://drewles.com:8011');
socket.emit("my other event", "yoyo")
socket.on("state", function (state) {
  render(state)
})
bindEvents()
</script>
</html>
